<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Enhanced Editor Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .controls {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 4px;
            }
            .button {
                padding: 8px 16px;
                margin: 5px;
                background: #007acc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .button:hover {
                background: #005a9e;
            }
            .button.active {
                background: #28a745;
            }
            .editor-container {
                border: 2px solid #ccc;
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 20px;
            }
            .info {
                padding: 15px;
                background: #e9ecef;
                border-radius: 4px;
                font-size: 14px;
            }
            .status {
                margin-top: 10px;
                padding: 10px;
                border-radius: 4px;
                font-weight: bold;
            }
            .status.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .status.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Enhanced Editor Test</h1>
            <p>
                This test verifies that the Enhanced Editor resizes without remounting and handles Monaco
                disposal errors gracefully.
            </p>

            <div class="controls">
                <h3>Resize Controls:</h3>
                <button class="button" onclick="resizeEditor('200px', '50%')">
                    Small (200px x 50%)
                </button>
                <button class="button" onclick="resizeEditor('300px', '75%')">
                    Medium (300px x 75%)
                </button>
                <button class="button" onclick="resizeEditor('400px', '100%')">
                    Large (400px x 100%)
                </button>
                <button class="button" onclick="resizeEditor('500px', '100%')">
                    Extra Large (500px x 100%)
                </button>

                <h3>Layout Controls:</h3>
                <button class="button" onclick="setLayout('horizontal')">Horizontal Layout</button>
                <button class="button" onclick="setLayout('vertical')">Vertical Layout</button>

                <h3>Error Simulation:</h3>
                <button class="button" onclick="simulateError()">Simulate Monaco Error</button>
                <button class="button" onclick="clearStatus()">Clear Status</button>
            </div>

            <div id="status" class="status" style="display: none"></div>

            <div id="layout-container" style="display: flex; gap: 10px; height: 400px">
                <div id="editor-panel" style="flex: 1">
                    <h3>Editor Panel</h3>
                    <div
                        id="editor-container"
                        class="editor-container"
                        style="height: calc(100% - 30px)"
                    >
                        <!-- Editor will be mounted here -->
                    </div>
                </div>
                <div
                    id="side-panel"
                    style="flex: 1; background: #f8f9fa; padding: 10px; border-radius: 4px"
                >
                    <h3>Side Panel</h3>
                    <p>This panel simulates other UI elements that might cause layout changes.</p>
                    <p>Current size: <span id="current-size">400px x 100%</span></p>
                    <p>Current layout: <span id="current-layout">horizontal</span></p>
                </div>
            </div>

            <div class="info">
                <h3>Test Instructions:</h3>
                <ol>
                    <li>Click in the editor and position your cursor somewhere in the middle</li>
                    <li>Type some text or select existing text</li>
                    <li>Click the resize buttons above</li>
                    <li>Verify that your cursor position and selection are preserved</li>
                    <li>Switch between horizontal and vertical layouts</li>
                    <li>Click "Simulate Monaco Error" to test error handling</li>
                    <li>Check the browser console for any disposal errors</li>
                </ol>

                <h3>Expected Behavior:</h3>
                <ul>
                    <li>✅ Editor should resize smoothly without remounting</li>
                    <li>✅ Cursor position and selection should be preserved during resize</li>
                    <li>✅ Layout changes should not cause editor remount</li>
                    <li>✅ Error simulation should be handled gracefully</li>
                    <li>✅ No "InstantiationService has been disposed" errors in console</li>
                </ul>
            </div>
        </div>

        <script>
            let currentHeight = "400px";
            let currentWidth = "100%";
            let currentLayout = "horizontal";
            let editorInstance = null;
            let mountCount = 0;

            // Mock Monaco Editor for testing
            function createMockEditor() {
                const container = document.getElementById("editor-container");
                container.innerHTML = `
                <div style="
                    height: 100%;
                    background: #1e1e1e;
                    color: #d4d4d4;
                    padding: 10px;
                    font-family: 'Consolas', 'Monaco', monospace;
                    font-size: 14px;
                    line-height: 1.5;
                    overflow: auto;
                    position: relative;
                ">
                    <div style="margin-bottom: 10px; color: #569cd6;">// VTL Script Editor</div>
                    <div style="margin-bottom: 5px;">ds_out := ds_in [calc r := random(150, 20)]</div>
                    <div style="margin-bottom: 5px;">[calc c := case when r < 0.2 then "Low" when r > 0.8 then "High" else "Medium"];</div>
                    <div style="margin-bottom: 5px;">a := datediff(cast("2022Q1", time_period), cast("2023Q2", time_period));</div>
                    <div style="margin-bottom: 5px;">b := dateadd(cast("2022Q1", time_period), 5, "M");</div>
                    <div style="margin-bottom: 5px;">c := getyear(cast("2022Q1", time_period));</div>
                    <div style="margin-bottom: 5px;">d := getmonth(cast("2020-12-14", date));</div>
                    <div style="margin-bottom: 5px;">e := dayofmonth(cast("2020-12-14", date));</div>
                    <div style="margin-bottom: 5px;">f := dayofyear(cast("2020-12-14", date));</div>
                    <div style="margin-bottom: 5px;">g := daytoyear(422);</div>
                    <div style="margin-bottom: 5px;">h := daytomonth(146);</div>
                    <div style="margin-bottom: 5px;">i := yeartoday(cast("P1Y20D", duration));</div>
                    <div style="margin-bottom: 5px;">j := monthtoday(cast("P3M10D", duration));</div>
                    <div style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #6a9955;">
                        Mount count: ${++mountCount} | Size: ${currentWidth} x ${currentHeight}
                    </div>
                </div>
            `;
            }

            function resizeEditor(height, width) {
                currentHeight = height;
                currentWidth = width;

                const container = document.getElementById("editor-container");
                container.style.height = height;
                container.style.width = width;

                // Simulate editor resize without remounting
                createMockEditor();

                document.getElementById("current-size").textContent = `${width} x ${height}`;
                showStatus(
                    `Editor resized to ${width} x ${height}. Mount count: ${mountCount}`,
                    "success"
                );
            }

            function setLayout(layout) {
                currentLayout = layout;
                const container = document.getElementById("layout-container");

                if (layout === "horizontal") {
                    container.style.display = "flex";
                    container.style.flexDirection = "row";
                } else {
                    container.style.display = "flex";
                    container.style.flexDirection = "column";
                }

                document.getElementById("current-layout").textContent = layout;
                showStatus(`Layout changed to ${layout}. Mount count: ${mountCount}`, "success");
            }

            function simulateError() {
                showStatus("Simulating Monaco disposal error...", "error");

                // Simulate the error
                setTimeout(() => {
                    const error = new Error("InstantiationService has been disposed");
                    console.warn("Simulated Monaco disposal error:", error);
                    showStatus(
                        "Error simulated. Check console for details. Editor should recover gracefully.",
                        "error"
                    );
                }, 100);
            }

            function showStatus(message, type) {
                const status = document.getElementById("status");
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = "block";
            }

            function clearStatus() {
                document.getElementById("status").style.display = "none";
            }

            // Initialize
            createMockEditor();
            showStatus(
                "Editor initialized. Try resizing or changing layout to test stability.",
                "success"
            );
        </script>
    </body>
</html>
